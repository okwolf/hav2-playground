<html>

<link rel="stylesheet" media="all" href="./index.css">

<body>
  <script type="module">
    import { app, h } from "./hyperapp";
    import html from "./html";
    import {
      Animation,
      Random,
      BatchFx,
      Merge
    } from "./fx"
    const { main, input, svg, path, circle, line } = html(h)

    const initialState = {
      theme: {
        color: "white",
        width: 2,
        trailColor: "grey",
        trailWidth: 0.5
      },
      time: 0,
      delta: 0,
      deltaS: 0,
      g: 0.98,
      friction: 0,
      timeScale: 20,

      l1: 150,
      m1: 15,
      x1: 0,
      y1: 0,
      a1: 3 * Math.PI / 4,
      av1: 0,
      aa1: 0,

      l2: 125,
      m2: 10,
      x2: 0,
      y2: 0,
      a2: Math.PI / 3,
      av2: 0,
      aa2: 0,

      trailPath: ""
    };

    const updateTime = time => ({ time: lastTime, delta: lastDelta }) => ({
      time,
      delta: time && lastTime ? time - lastTime : lastDelta
    });

    const updateDelta = ({ delta, timeScale }) => ({
      deltaS: Math.min(delta, timeScale) / timeScale
    });

    const updateVelocities = ({ deltaS, av1, aa1, av2, aa2, friction }) => ({
      av1: (av1 + aa1 * deltaS) * (1 - friction),
      av2: (av2 + aa2 * deltaS) * (1 - friction)
    });

    const updateAccelerations = ({ g, l1, l2, m1, m2, a1, a2, av1, av2 }) => ({
      aa1:
        (-g * (2 * m1 + m2) * Math.sin(a1) -
          m2 * g * Math.sin(a1 - 2 * a2) -
          2 *
          Math.sin(a1 - a2) *
          m2 *
          (av2 * av2 * l2 + av1 * av1 * l1 * Math.cos(a1 - a2))) /
        (l1 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2))),
      aa2:
        2 *
        Math.sin(a1 - a2) *
        (av1 * av1 * l1 * (m1 + m2) +
          g * (m1 + m2) * Math.cos(a1) +
          av2 * av2 * l2 * m2 * Math.cos(a1 - a2)) /
        (l2 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2)))
    });

    const updateAngles = ({ deltaS, a1, av1, a2, av2 }) => ({
      a1: a1 + av1 * deltaS,
      a2: a2 + av2 * deltaS
    });

    const updateRod1 = ({ l1, a1 }) => ({
      x1: l1 * Math.sin(a1),
      y1: l1 * Math.cos(a1)
    });

    const updateRod2 = ({ l2, a2, x1, y1 }) => ({
      x2: x1 + l2 * Math.sin(a2),
      y2: y1 + l2 * Math.cos(a2)
    });

    const updateTrail = ({ trailPath, x2, y2 }) => ({
      trailPath: trailPath ? `${trailPath} L ${x2} ${y2}` : `M${x2} ${y2}`
    });

    const UpdateAnimation = (state, time) => [
      state,
      BatchFx(
        Merge(updateTime(time)),
        Merge(updateDelta),
        Merge(updateVelocities),
        Merge(updateAccelerations),
        Merge(updateAngles),
        Merge(updateRod1),
        Merge(updateRod2),
        Merge(updateTrail)
      )
    ];

    const AnimationSub = [Animation(UpdateAnimation)];

    const RandomTimeScale = Random({
      min: 40,
      max: 80,
      action: (state, timeScale) => ({ ...state, timeScale })
    });

    const RandomAngle1 = Random({
      min: Math.PI / 2,
      max: 3 * Math.PI / 2,
      action: (state, a1) => ({ ...state, a1 })
    });

    const RandomAngle2 = Random({
      min: Math.PI / 2,
      max: 3 * Math.PI / 2,
      action: (state, a2) => ({ ...state, a2 })
    });

    const RandomizeInitialState = BatchFx(
      RandomTimeScale,
      RandomAngle1,
      RandomAngle2
    );

    const SetValueFor = key => (state, { target: { value } }) => ({
      ...state,
      [key]: value
    });

    const view = ({
      theme: { color, width, trailColor, trailWidth },
      x1,
      y1,
      m1,
      l1,
      x2,
      y2,
      m2,
      l2,
      trailPath,
      g,
      timeScale,
      friction
    }) =>
      main(
        input({
          type: "range",
          value: g,
          min: 0.5,
          max: 1,
          step: 0.001,
          oninput: SetValueFor("g")
        }),
        input({
          type: "range",
          value: timeScale,
          min: 1,
          max: 200,
          oninput: SetValueFor("timeScale")
        }),
        input({
          type: "range",
          value: l1,
          min: 50,
          max: 200,
          oninput: SetValueFor("l1")
        }),
        input({
          type: "range",
          value: l2,
          min: 50,
          max: 200,
          oninput: SetValueFor("l2")
        }),
        input({
          type: "range",
          value: friction,
          min: 0,
          max: 0.01,
          step: 0.0001,
          oninput: SetValueFor("friction")
        }),
        svg(
          {
            viewBox: "0 0 400 300",
            style: {
              strokeWidth: width
            },
            stroke: color
          },
          path({
            d: trailPath,
            style: {
              strokeWidth: trailWidth
            },
            fill: "transparent",
            stroke: trailColor
          }),
          circle({ cx: 0, cy: 0, r: width, fill: color }),
          line({ x1: 0, y1: 0, x2: x1, y2: y1 }),
          circle({ cx: x1, cy: y1, r: m1, fill: color }),
          line({ x1, y1, x2, y2 }),
          circle({ cx: x2, cy: y2, r: m2, fill: color })
        )
      );

    app({
      init: [initialState, RandomizeInitialState],
      view,
      container: document.body,
      subscribe: () => AnimationSub
    });

  </script>
</body>

</html>