<html>

<link rel="stylesheet" media="all" href="./index.css">

<body class="centered">
  <script type="module">
    import { app, h } from "./hyperapp";
    import html from "./html";
    import { WebSocketClient } from "./fx"
    const { main, h1, button } = html(h)

    const ORDER_URL = "wss://ws.pusherapp.com/app/de504dc5763aeef9ff52"

    const OrderMessage = (state, message) => {
      const data = JSON.parse(message.data);
      return data.event === "order_created"
        ? {
          ...state,
          lastPrice: state.currentPrice,
          currentPrice: JSON.parse(data.data).price
        }
        : state;
    };

    const BtcOrderSub = WebSocketClient({
      url: ORDER_URL,
      send: JSON.stringify({
        event: "pusher:subscribe",
        data: { channel: "live_orders" }
      }),
      listen: OrderMessage
    });

    app({
      init: {
        paused: false,
        lastPrice: null,
        currentPrice: null
      },
      view: ({ lastPrice, currentPrice, paused }) =>
        main(
          h1(
            {
              class: currentPrice < lastPrice ? "decreased" : "increased"
            },
            currentPrice ? `$${currentPrice.toFixed(2)}` : "Loading..."
          ),
          button({ onClick: state => ({ ...state, paused: !state.paused }) }, paused ? "RESUME" : "PAUSE")
        ),
      subscriptions: ({ paused }) => paused ? [] : [BtcOrderSub],
      container: document.body
    });
  </script>
</body>

</html>